<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Projet Gare - Recherche par Département et Gare</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script src="./utils.js"></script>
  <style>
    #map {
      width: 100%;
      height: 600px;
    }

    #controls {
      margin: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #department-select,
    #station-select {
      padding: 5px;
      font-size: 14px;
    }

    #station-select {
      display: none;
    }
  </style>
  <script>
    let map, geojsonLayer;

    window.onload = async () => {
      try {
        // Initialisation de la carte
        map = L.map('map', {
          center: [48.4, 2.5],
          zoom: 6
        });

        // Ajouter les tuiles de fond
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 20
        }).addTo(map);

        // Charger les données GeoJSON
        const geojsonResponse = await fetch("gares-de-voyageurs.geojson");
        const geojsonData = await geojsonResponse.json();
        console.log(geojsonData);

        // Charger les horaires à partir du CSV
       const horairesCSV = await fetchCSV("horaires-des-gares1.csv");
       const horaires = horairesCSV.reduce((acc, current) => {
        const gare = current.gare?.trim();
        if(!acc[gare]){
          acc[gare] = []
        }
        acc[gare].push(current);
        return acc;
       }, {})


        // Ajouter les horaires aux données GeoJSON
        geojsonData.features.forEach(feature => {
          const libelle = feature.properties.nom
          const gare = horaires[libelle];
          if(gare){
            feature.properties.horaires = gare.map(j => ({
              jour: j.jour_de_la_semaine,
              horaireNormaux: j.horaire_en_jour_normal,
              horaireFerie: j.horaire_en_jour_ferie
            }));
          }
          //console.log(feature.properties.horaires)
        });


        // Ajouter la couche GeoJSON
        geojsonLayer = L.geoJSON(geojsonData, {
          onEachFeature: (feature, layer) => {
            let popupContent = `<strong>${feature.properties.nom}</strong>`;
            popupContent += `<br><strong>Horaires :</strong><ul>`;
            
            if (feature.properties.horaires) {
              const lignes = trieJourSemaine(Object.entries(feature.properties.horaires));
              //console.log(lignes);
              lignes.forEach(([key, horaires]) => {
            
            const ligneHTML = `
              <div>
                <strong>${horaires.jour}</strong> :
                <ul>
                  <li>${horaires.horaireNormaux}</li>
                </ul>
              </div>
            `;
              popupContent += ligneHTML
          })

      
            } else {
              popupContent += `Horraire indisponibles`;
            }
            popupContent += `</ul>`;
            

            layer.bindPopup(popupContent);
          },
          pointToLayer: (feature, latlng) => {
            return L.circleMarker(latlng, {
              radius: 6,
              fillColor: "#007bff",
              color: "#000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
          }
        }).addTo(map);

        // Remplir la liste des départements
        const departmentSelect = document.getElementById('department-select');
        const stationSelect = document.getElementById('station-select');
        const departments = [...new Set(geojsonData.features.map(f => f.properties.departemen))].sort();
        departments.forEach(dept => {
          const option = document.createElement('option');
          option.value = dept;
          option.textContent = dept;
          departmentSelect.appendChild(option);
        });

        // Ajouter un écouteur pour filtrer par département
        departmentSelect.addEventListener('change', (event) => {
          const department = event.target.value;
          if (geojsonLayer) {
            map.removeLayer(geojsonLayer);
          }

          const filteredData = {
            type: "FeatureCollection",
            features: department === "all"
              ? geojsonData.features
              : geojsonData.features.filter(f => f.properties.departemen === department)
          };

/*           geojsonLayer = L.geoJSON(filteredData, {
            onEachFeature: (feature, layer) => {
              let popupContent = `<strong>${feature.properties.libelle}</strong>`;
              if (feature.properties.horaires) {
                popupContent += `<br>Ouverture : ${feature.properties.horaires.horaireNormaux}`;
              } else {
                popupContent += `<br>Horaires non disponibles`;
              }
              layer.bindPopup(popupContent);
            },
            pointToLayer: (feature, latlng) => {
              return L.circleMarker(latlng, {
                radius: 6,
                fillColor: "#007bff",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
              });
            }
          }).addTo(map); */

          // Centrer la carte sur les gares filtrées
          const bounds = geojsonLayer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds);
          }

          // Mettre à jour la liste des gares
          updateStationList(filteredData.features);
        });

        // Fonction pour mettre à jour la liste des gares
        function updateStationList(features) {
          stationSelect.innerHTML = '<option value="">Choisissez une gare</option>';
          stationSelect.style.display = features.length > 0 ? 'block' : 'none';

          features.forEach(f => {
            const option = document.createElement('option');
            option.value = JSON.stringify(f.geometry.coordinates);
            option.textContent = f.properties.libelle;
            stationSelect.appendChild(option);
          });

          // Centrer la carte sur la gare sélectionnée
          stationSelect.addEventListener('change', (event) => {
            const coordinates = JSON.parse(event.target.value);
            if (coordinates) {
              map.setView([coordinates[1], coordinates[0]], 13);
            }
          });
        }

        

        // Fonction pour charger le CSV
        async function fetchCSV(filePath) {
          const response = await fetch(filePath);
          const text = await response.text();
          return Papa.parse(text, { header: true }).data;
        }
      } catch (error) {
        console.error("Une erreur est survenue :", error);
        alert("Une erreur est survenue : " + error.message);
      }
    };
  </script>
</head>

<body>
  <div id="controls">
    <label for="department-select">Choisir un département : </label>
    <select id="department-select">
      <option value="all">Tous</option>
    </select>
    <select id="station-select"></select>
  </div>
  <div id="map"></div>
</body>

</html>
